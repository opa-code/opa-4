# Build and release

name: Make Release

on:
  push:
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10
      #- "v*.*.*"

permissions:
  contents: write # Required to create releases      

jobs:

  windows-build:
    name: Build Windows executable
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download Lazarus installer
        shell: powershell
        run: |
          curl.exe -L -o lazarus-installer.exe "https://sourceforge.net/projects/lazarus/files/Lazarus%20Windows%2064%20bits/Lazarus%204.2/lazarus-4.2-fpc-3.2.2-win64.exe/download"
      
      - name: Install Lazarus silently
        shell: powershell
        run: |
          Start-Process -FilePath "lazarus-installer.exe" -ArgumentList "/VERYSILENT" -Wait

      - name: Build Lazarus project
        shell: powershell
        run: |
          $env:PATH += ";C:\lazarus\"
          lazbuild --version
          lazbuild opa4/opa.lpi
          mkdir build\opa_${{ github.ref_name }}
          copy opa4\lib\*\*.exe build\opa_${{ github.ref_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opa_${{ github.ref_name }}
          path: build\opa_${{ github.ref_name }} 
             
  release:
    name: Create Release
    needs: windows-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        
      - name: Download Windows executable
        uses: actions/download-artifact@v5
        with:
          name: opa_${{ github.ref_name }}
          path: windows_exe

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: true
          files: windows_exe/opa_${{ github.ref_name }}/*
          
